<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 2rem;
    }
    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .now-section {
      background-color: #fef9e7;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      border-left: 6px solid #f39c12;
    }
    .now-title {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .now-detail {
      font-size: 1.2rem;
      margin: 0.25rem 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .loading {
      text-align: center;
      font-style: italic;
      color: gray;
    }
  </style>
</head>
<body>

  <h2>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>

  <div id="bookingNow"></div>
  <div id="bookingList"><p class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>

  <script>
    var API_URL = "https://default03c56608515c49f3b2e42aad4e09c8.ce.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9cb2c5df518448a4bae5a5ee7dee45ef/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=i3-M9sFxI8UXWcvTEwkVbSyC7wjD0zq4MbIfWSdCxps"; // <-- ‡πÉ‡∏™‡πà URL ‡∏à‡∏£‡∏¥‡∏á
    var API_KEY = "D3s01bTjuux8n2iklXpt26URPcXtb7bO";      // <-- ‡πÉ‡∏™‡πà key ‡∏à‡∏£‡∏¥‡∏á

    function loadBookings() {
      try {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", API_URL, true);
        xhr.setRequestHeader("x-api-key", API_KEY);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              try {
                var data = JSON.parse(xhr.responseText);
                if (Object.prototype.toString.call(data) === '[object Array]') {
                  renderTable(data);
                } else {
                  document.getElementById("bookingList").innerHTML =
                    '<p style="color:red">' + data.message + '</p>';
                }
              } catch (e) {
                document.getElementById("bookingList").innerHTML =
                  '<p style="color:red">‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>';
              }
            } else {
              document.getElementById("bookingList").innerHTML =
                '<p style="color:red">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß [' + xhr.status + ']</p>';
            }
          }
        };
        xhr.send(null);
      } catch (err) {
        document.getElementById("bookingList").innerHTML =
          '<p style="color:red">üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ<br /><small>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ' + err.message + '</small></p>';
      }
    }

    function parseTimeRange(start, end) {
      function toMinutes(t) {
        var parts = t.split(":");
        return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
      }
      return [toMinutes(start), toMinutes(end)];
    }

    function getNowDateTime() {
      var now = new Date();
      var pad = function(n) {
        return (n < 10 ? '0' : '') + n;
      };
      var today = now.getFullYear() + "-" + pad(now.getMonth()+1) + "-" + pad(now.getDate());
      var nowMinutes = now.getHours() * 60 + now.getMinutes();
      return { today: today, nowMinutes: nowMinutes };
    }

    function renderTable(data) {
      var nowInfo = getNowDateTime();
      var today = nowInfo.today;
      var nowMinutes = nowInfo.nowMinutes;
      var nowList = [];
      var otherList = [];

      for (var i = 0; i < data.length; i++) {
        var item = data[i];
        var range = parseTimeRange(item.start, item.end);
        var isToday = item.date === today;
        var isNow = isToday && nowMinutes >= range[0] && nowMinutes < range[1];

        if (isNow) {
          nowList.push(item);
        } else {
          otherList.push(item);
        }
      }

      // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      var bookingNow = document.getElementById("bookingNow");
      if (nowList.length > 0) {
        var html = "";
        for (var j = 0; j < nowList.length; j++) {
          var item = nowList[j];
          html += '<div class="now-section">' +
                  '<div class="now-title">' + item.title + '</div>' +
                  '<div class="now-detail">üïí ' + item.start + ' - ' + item.end + '</div>' +
                  '<div class="now-detail">üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ' + item.by + '</div>' +
                  '<div class="now-detail">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: ' + item.count +
                  (item.external ? ' (‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å)' : '') + '</div>' +
                  '</div>';
        }
        bookingNow.innerHTML = html;
      } else {
        bookingNow.innerHTML = "";
      }

      // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô
      var bookingList = document.getElementById("bookingList");
      if (otherList.length > 0) {
        var table = '<table><thead><tr>' +
                    '<th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th><th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>' +
                    '<th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th><th>‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å</th></tr></thead><tbody>';

        for (var k = 0; k < otherList.length; k++) {
          var item = otherList[k];
          table += '<tr>' +
                   '<td>' + item.title + '</td>' +
                   '<td>' + item.by + '</td>' +
                   '<td>' + item.date + '</td>' +
                   '<td>' + item.start + ' - ' + item.end + '</td>' +
                   '<td>' + item.count + '</td>' +
                   '<td>' + (item.external ? '‚úÖ' : '‚ùå') + '</td>' +
                   '</tr>';
        }
        table += '</tbody></table>';
        bookingList.innerHTML = table;
      } else {
        bookingList.innerHTML = '<p class="loading">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô</p>';
      }
    }

    var lastFetchedMinute = -1;
    function maybeFetch() {
      var now = new Date();
      var minute = now.getMinutes();
      var second = now.getSeconds();
      if ((minute % 30 === 0) && second === 0 && lastFetchedMinute !== minute) {
        lastFetchedMinute = minute;
        loadBookings();
      }
    }

    document.addEventListener("DOMContentLoaded", function() {
      loadBookings();
      setInterval(maybeFetch, 1000);
    });
  </script>

</body>
</html>
