<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 2rem;
    }
    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .now-section {
      background-color: #fef9e7;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      border-left: 6px solid #f39c12;
    }
    .now-title {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .now-detail {
      font-size: 1.2rem;
      margin: 0.25rem 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .loading {
      text-align: center;
      font-style: italic;
      color: gray;
    }
  </style>
</head>
<body>

  <h2>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>

  <div id="bookingNow"></div>
  <div id="bookingList"><p class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>

  <script>
    const API_URL = "https://your-flow-url"; // <-- ‡πÉ‡∏™‡πà URL ‡∏à‡∏£‡∏¥‡∏á
    const API_KEY = "mysupersecret123";      // <-- ‡πÉ‡∏™‡πà key ‡∏à‡∏£‡∏¥‡∏á

    async function loadBookings() {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "x-api-key": API_KEY
          }
        });

        const data = await res.json();
        if (Array.isArray(data)) {
          renderTable(data);
        } else {
          document.getElementById("bookingList").innerHTML = `<p style="color:red">${data.message}</p>`;
        }
      } catch (err) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", err);
        document.getElementById("bookingList").innerHTML = `<p style="color:red">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>`;
      }
    }

    function parseTimeRange(start, end) {
      const toMinutes = t => {
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      };
      return [toMinutes(start), toMinutes(end)];
    }

    function getNowDateTime() {
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const today = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      return { today, nowMinutes };
    }

    function renderTable(data) {
      const { today, nowMinutes } = getNowDateTime();
      const nowList = [];
      const otherList = [];

      data.forEach(item => {
        const [startMin, endMin] = parseTimeRange(item.start, item.end);
        const isToday = item.date === today;
        const isNow = isToday && nowMinutes >= startMin && nowMinutes < endMin;

        if (isNow) {
          nowList.push(item);
        } else {
          otherList.push(item);
        }
      });

      // üìå ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
      const nowHTML = nowList.length > 0 ? nowList.map(item => `
        <div class="now-section">
          <div class="now-title">${item.title}</div>
          <div class="now-detail">üïí ${item.start} - ${item.end}</div>
          <div class="now-detail">üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${item.by}</div>
          <div class="now-detail">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: ${item.count} ${item.external ? '(‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å)' : ''}</div>
        </div>
      `).join("") : "";

      document.getElementById("bookingNow").innerHTML = nowHTML;

      // üìå ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ
      let table = `
        <table>
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
              <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th>
              <th>‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å</th>
            </tr>
          </thead>
          <tbody>
      `;

      otherList.forEach(item => {
        table += `
          <tr>
            <td>${item.title}</td>
            <td>${item.by}</td>
            <td>${item.date}</td>
            <td>${item.start} - ${item.end}</td>
            <td>${item.count}</td>
            <td>${item.external ? "‚úÖ" : "‚ùå"}</td>
          </tr>
        `;
      });

      table += "</tbody></table>";
      document.getElementById("bookingList").innerHTML = table;
    }

    // üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ xx:00 ‡∏´‡∏£‡∏∑‡∏≠ xx:30
    let lastFetchedMinute = null;
    function maybeFetch() {
      const now = new Date();
      const minute = now.getMinutes();
      const second = now.getSeconds();
      const shouldFetch = (minute % 30 === 0) && second === 0;

      if (shouldFetch && lastFetchedMinute !== minute) {
        lastFetchedMinute = minute;
        loadBookings();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadBookings(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      setInterval(maybeFetch, 1000*60); // ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ x 60 = 1 ‡∏ô‡∏≤‡∏ó‡∏µ
    });
  </script>

</body>
</html>
