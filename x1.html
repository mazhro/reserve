<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 2rem;
    }
    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .now-section {
      background-color: #fef9e7;
      padding: 1rem 1.5rem;
      margin-bottom: 2rem;
      border-left: 6px solid #f39c12;
    }
    .now-title {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .now-detail {
      font-size: 1.2rem;
      margin: 0.25rem 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .loading {
      text-align: center;
      font-style: italic;
      color: gray;
    }
  </style>
</head>
<body>

  <h2>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h2>

  <div id="bookingNow"></div>
  <div id="bookingList"><p class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>

  <script>
    const API_URL = "https://default03c56608515c49f3b2e42aad4e09c8.ce.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9cb2c5df518448a4bae5a5ee7dee45ef/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=i3-M9sFxI8UXWcvTEwkVbSyC7wjD0zq4MbIfWSdCxps"; // <-- ‡πÉ‡∏™‡πà URL ‡∏à‡∏£‡∏¥‡∏á
    const API_KEY = "D3s01bTjuux8n2iklXpt26URPcXtb7bO";      // <-- ‡πÉ‡∏™‡πà key ‡∏à‡∏£‡∏¥‡∏á

    async function loadBookings() {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "x-api-key": API_KEY
          }
        });

        const data = await res.json();
        if (Array.isArray(data)) {
          renderTable(data);
        } else {
          document.getElementById("bookingList").innerHTML = `<p style="color:red">${data.message}</p>`;
        }
      } catch (err) {
        console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", err);
        const errorMsg = err?.message || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏";
      
        document.getElementById("bookingList").innerHTML = `
          <p style="color:red">
            üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ<br />
            <small>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${errorMsg}</small>
          </p>
        `;
      }
    }

    function parseTimeRange(start, end) {
      const toMinutes = t => {
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      };
      return [toMinutes(start), toMinutes(end)];
    }

    function getNowDateTime() {
      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const today = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      return { today, nowMinutes };
    }

    function renderTable(data) {
      const { today, nowMinutes } = getNowDateTime();
      const nowList = [];
      const otherList = [];
    
      data.forEach(item => {
        const [startMin, endMin] = parseTimeRange(item.start, item.end);
        const isToday = item.date === today;
        const isNow = isToday && nowMinutes >= startMin && nowMinutes < endMin;
    
        console.log("üîé", item.title, "now=", nowMinutes, "start=", startMin, "end=", endMin);
    
        if (isNow) {
          nowList.push(item);
        } else {
          otherList.push(item);
        }
      });
    
      // ‚úÖ 1. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ now ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡πà‡∏ô
      const bookingNow = document.getElementById("bookingNow");
      if (nowList.length > 0) {
        bookingNow.innerHTML = nowList.map(item => `
          <div class="now-section">
            <div class="now-title">${item.title}</div>
            <div class="now-detail">üïí ${item.start} - ${item.end}</div>
            <div class="now-detail">üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${item.by}</div>
            <div class="now-detail">üë• ‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°: ${item.count} ${item.external ? '(‡∏°‡∏µ‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å)' : ''}</div>
          </div>
        `).join('');
      } else {
        bookingNow.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ now
      }
    
      // ‚úÖ 2. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const bookingList = document.getElementById("bookingList");
      if (otherList.length > 0) {
        let table = `
          <table>
            <thead>
              <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</th>
                <th>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th>
                <th>‡∏Ñ‡∏ô‡∏ô‡∏≠‡∏Å</th>
              </tr>
            </thead>
            <tbody>
        `;
    
        otherList.forEach(item => {
          table += `
            <tr>
              <td>${item.title}</td>
              <td>${item.by}</td>
              <td>${item.date}</td>
              <td>${item.start} - ${item.end}</td>
              <td>${item.count}</td>
              <td>${item.external ? "‚úÖ" : "‚ùå"}</td>
            </tr>
          `;
        });
    
        table += "</tbody></table>";
        bookingList.innerHTML = table;
      } else {
        bookingList.innerHTML = `<p class="loading">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô</p>`;
      }
    }

    
    // üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ xx:00 ‡∏´‡∏£‡∏∑‡∏≠ xx:30
    let lastFetchedMinute = null;
    function maybeFetch() {
      const now = new Date();
      const minute = now.getMinutes();
      const second = now.getSeconds();
      const shouldFetch = (minute % 30 === 0) && second === 0;

      if (shouldFetch && lastFetchedMinute !== minute) {
        lastFetchedMinute = minute;
        loadBookings();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadBookings(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      setInterval(maybeFetch, 1000*60); // ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ x 60 = 1 ‡∏ô‡∏≤‡∏ó‡∏µ
    });
  </script>

</body>
</html>
